<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#667eea">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>ä»Šæ—¥å¾…åŠ</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“</text></svg>">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html, body { height: 100%; overflow: hidden; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
    .container { width: 100%; height: 100vh; display: flex; flex-direction: column; max-width: 500px; margin: 0 auto; }
    .title-bar { display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; padding-top: max(16px, env(safe-area-inset-top)); background: rgba(255,255,255,0.1); }
    .title { color: white; font-size: 20px; font-weight: 600; }
    .sync-status { color: rgba(255,255,255,0.8); font-size: 12px; padding: 4px 10px; background: rgba(255,255,255,0.15); border-radius: 12px; cursor: pointer; }
    .sync-status.error { background: rgba(255,100,100,0.3); }
    .sync-status.syncing { animation: pulse 1s infinite; }
    @keyframes pulse { 50% { opacity: 0.5; } }
    .add-todo { display: flex; padding: 16px 20px; gap: 12px; }
    .add-todo input { flex: 1; padding: 14px 18px; border: none; border-radius: 25px; font-size: 16px; background: rgba(255,255,255,0.95); outline: none; }
    .add-todo button { width: 50px; height: 50px; border: none; border-radius: 50%; background: rgba(255,255,255,0.3); color: white; font-size: 28px; cursor: pointer; transition: transform 0.2s; }
    .add-todo button:active { transform: scale(0.95); }
    .todo-list { flex: 1; overflow-y: auto; padding: 8px 20px; }
    .todo-item { display: flex; align-items: center; padding: 16px 18px; margin-bottom: 10px; background: rgba(255,255,255,0.15); border-radius: 16px; cursor: pointer; animation: slideIn 0.3s; transition: transform 0.2s, background 0.2s; }
    .todo-item:active { transform: scale(0.98); }
    @keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } }
    .todo-item.completed { background: rgba(255,255,255,0.08); }
    .todo-item.completed .todo-text { text-decoration: line-through; opacity: 0.6; }
    .checkbox { width: 26px; height: 26px; border: 2px solid rgba(255,255,255,0.6); border-radius: 50%; margin-right: 14px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: all 0.2s; }
    .todo-item.completed .checkbox { background: rgba(255,255,255,0.4); border-color: transparent; }
    .checkbox::after { content: 'âœ“'; color: white; opacity: 0; transition: opacity 0.2s; }
    .todo-item.completed .checkbox::after { opacity: 1; }
    .todo-text { flex: 1; color: white; font-size: 16px; word-break: break-word; line-height: 1.4; }
    .delete-btn { width: 32px; height: 32px; border: none; border-radius: 50%; background: rgba(255,100,100,0.5); color: white; font-size: 18px; cursor: pointer; flex-shrink: 0; opacity: 0.7; transition: opacity 0.2s; }
    .delete-btn:hover { opacity: 1; }
    .stats { padding: 16px 20px; padding-bottom: max(16px, env(safe-area-inset-bottom)); text-align: center; color: rgba(255,255,255,0.7); font-size: 14px; background: rgba(0,0,0,0.1); }
    .empty-state { text-align: center; padding: 60px 20px; color: rgba(255,255,255,0.6); }
    .empty-state .icon { font-size: 64px; margin-bottom: 16px; }
    .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; padding: 20px; z-index: 1000; backdrop-filter: blur(4px); }
    .modal-box { background: white; border-radius: 24px; padding: 28px; max-width: 380px; width: 100%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
    .modal-box h2 { margin-bottom: 8px; color: #333; font-size: 22px; }
    .modal-box .subtitle { color: #888; font-size: 14px; margin-bottom: 20px; }
    .modal-box input { width: 100%; padding: 14px 18px; border: 2px solid #eee; border-radius: 14px; font-size: 16px; margin-bottom: 16px; outline: none; transition: border-color 0.2s; }
    .modal-box input:focus { border-color: #667eea; }
    .modal-box button { width: 100%; padding: 16px; border: none; border-radius: 14px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-size: 16px; font-weight: 600; cursor: pointer; transition: transform 0.2s; }
    .modal-box button:active { transform: scale(0.98); }
    .modal-box .hint { font-size: 13px; color: #999; margin-top: 16px; text-align: center; line-height: 1.5; }
    .hidden { display: none !important; }
  </style>
</head>
<body>
  <div class="modal" id="setupModal">
    <div class="modal-box">
      <h2>ğŸ”— äº‘åŒæ­¥è®¾ç½®</h2>
      <p class="subtitle">è¾“å…¥åŒæ­¥å¯†é’¥ï¼Œæ‰€æœ‰è®¾å¤‡ä½¿ç”¨ç›¸åŒå¯†é’¥å³å¯å…±äº«å¾…åŠæ¸…å•</p>
      <input type="text" id="syncKeyInput" placeholder="è¾“å…¥æ‚¨çš„åŒæ­¥å¯†é’¥" autocomplete="off">
      <button onclick="startSync()">å¼€å§‹ä½¿ç”¨</button>
      <p class="hint">ğŸ’¡ å¯†é’¥å¯ä»¥æ˜¯ä»»æ„å­—ç¬¦ä¸²ï¼Œå¦‚ "my-todo-2024"<br>è¯·è®°ä½å®ƒï¼Œåœ¨å…¶ä»–è®¾å¤‡ä¸Šè¾“å…¥ç›¸åŒå¯†é’¥</p>
    </div>
  </div>

  <div class="container">
    <div class="title-bar">
      <span class="title">ğŸ“ ä»Šæ—¥å¾…åŠ</span>
      <span class="sync-status" id="syncStatus" onclick="showSettings()">âš™ï¸</span>
    </div>
    <div class="add-todo">
      <input type="text" id="todoInput" placeholder="æ·»åŠ æ–°ä»»åŠ¡..." enterkeyhint="done">
      <button onclick="addTodo()">+</button>
    </div>
    <div class="todo-list" id="todoList"></div>
    <div class="stats"><span id="statsText">åŠ è½½ä¸­...</span></div>
  </div>

  <script>
    const API_URL = '/api/todos';
    let todos = [];
    let syncKey = '';
    let syncing = false;

    async function init() {
      syncKey = localStorage.getItem('todo-sync-key') || '';
      if (!syncKey) {
        document.getElementById('setupModal').classList.remove('hidden');
        document.getElementById('statsText').textContent = 'è¯·å…ˆè®¾ç½®åŒæ­¥å¯†é’¥';
        return;
      }
      document.getElementById('setupModal').classList.add('hidden');
      
      await loadTodos();
      
      document.getElementById('todoInput').addEventListener('keydown', e => {
        if (e.key === 'Enter') { e.preventDefault(); addTodo(); }
      });
      
      // è‡ªåŠ¨åŒæ­¥
      setInterval(() => loadTodos(true), 30000);
      document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'visible') loadTodos(true);
      });
    }

    function startSync() {
      const key = document.getElementById('syncKeyInput').value.trim();
      if (key.length < 2) {
        alert('å¯†é’¥è‡³å°‘éœ€è¦2ä¸ªå­—ç¬¦');
        return;
      }
      syncKey = key;
      localStorage.setItem('todo-sync-key', key);
      document.getElementById('setupModal').classList.add('hidden');
      loadTodos();
    }

    function showSettings() {
      document.getElementById('syncKeyInput').value = syncKey;
      document.getElementById('setupModal').classList.remove('hidden');
    }

    async function loadTodos(silent = false) {
      if (syncing) return;
      syncing = true;
      if (!silent) setStatus('syncing', 'åŒæ­¥ä¸­...');
      
      try {
        const res = await fetch(`${API_URL}?key=${encodeURIComponent(syncKey)}`);
        if (res.ok) {
          const data = await res.json();
          todos = data.todos || [];
          setStatus('ok', 'å·²åŒæ­¥ âœ“');
        } else {
          throw new Error('API error');
        }
      } catch (e) {
        console.error('Load error:', e);
        // å°è¯•ä½¿ç”¨æœ¬åœ°ç¼“å­˜
        const cached = localStorage.getItem('todos-cache-' + syncKey);
        if (cached) todos = JSON.parse(cached);
        setStatus('error', 'ç¦»çº¿æ¨¡å¼');
      }
      
      syncing = false;
      renderTodos();
    }

    async function saveTodos() {
      // å…ˆä¿å­˜æœ¬åœ°ç¼“å­˜
      localStorage.setItem('todos-cache-' + syncKey, JSON.stringify(todos));
      
      setStatus('syncing', 'ä¿å­˜ä¸­...');
      try {
        const res = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ key: syncKey, todos })
        });
        if (res.ok) {
          setStatus('ok', 'å·²åŒæ­¥ âœ“');
        } else {
          throw new Error('Save failed');
        }
      } catch (e) {
        console.error('Save error:', e);
        setStatus('error', 'ä¿å­˜å¤±è´¥');
      }
    }

    function setStatus(type, text) {
      const el = document.getElementById('syncStatus');
      el.textContent = text;
      el.className = 'sync-status' + (type === 'error' ? ' error' : '') + (type === 'syncing' ? ' syncing' : '');
    }

    function renderTodos() {
      const list = document.getElementById('todoList');
      if (todos.length === 0) {
        list.innerHTML = '<div class="empty-state"><div class="icon">ğŸ‰</div><div class="text">æš‚æ— å¾…åŠäº‹é¡¹<br>æ·»åŠ ä¸€ä¸ªä»»åŠ¡å¼€å§‹å§ï¼</div></div>';
      } else {
        list.innerHTML = todos.map((t, i) => `
          <div class="todo-item ${t.completed ? 'completed' : ''}" onclick="toggle(${i})">
            <div class="checkbox"></div>
            <span class="todo-text">${escape(t.text)}</span>
            <button class="delete-btn" onclick="del(event,${i})">Ã—</button>
          </div>
        `).join('');
      }
      updateStats();
    }

    function updateStats() {
      const done = todos.filter(t => t.completed).length;
      document.getElementById('statsText').textContent = 
        todos.length ? `${todos.length - done} é¡¹å¾…åŠ Â· ${done} é¡¹å·²å®Œæˆ` : 'å¼€å§‹æ·»åŠ ä»»åŠ¡å§ âœ¨';
    }

    function addTodo() {
      const input = document.getElementById('todoInput');
      const text = input.value.trim();
      if (text) {
        todos.unshift({ id: Date.now(), text, completed: false });
        input.value = '';
        renderTodos();
        saveTodos();
      }
    }

    function toggle(i) {
      todos[i].completed = !todos[i].completed;
      renderTodos();
      saveTodos();
    }

    function del(e, i) {
      e.stopPropagation();
      todos.splice(i, 1);
      renderTodos();
      saveTodos();
    }

    function escape(s) {
      return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    init();
  </script>
</body>
</html>
